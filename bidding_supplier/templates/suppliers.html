{% extends "_base.html" %}
{% load static %}
{% load ui_tags %}
{% block title %}
Fornecedores
{% endblock title %}
{% block content %}
<div class="mx-auto max-w-7xl" x-data="{ showForm: {% if form.errors %}true{% else %}false{% endif %} }">
    <!-- Breadcrumbs -->
    <div class="mb-6 flex flex-wrap gap-2 items-center">
        <a class="text-sm font-medium leading-normal text-gray-500 dark:text-gray-400 hover:text-brand-600 dark:hover:text-brand-400 transition-colors"
            href="{% url 'dashboard:index' %}">Início</a>
        <span class="text-sm font-medium leading-normal text-gray-500 dark:text-gray-400">/</span>
        <span class="text-sm font-medium leading-normal text-gray-500 dark:text-gray-400">Licitações</span>
        <span class="text-sm font-medium leading-normal text-gray-500 dark:text-gray-400">/</span>
        <span class="text-sm font-medium leading-normal text-gray-900 dark:text-white">Fornecedores</span>
    </div>

    <!-- Header -->
    <div class="mb-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Fornecedores</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">Gerencie os fornecedores do município.</p>
        </div>
        <button @click="showForm = !showForm"
            class="text-white bg-brand-600 hover:bg-brand-700 focus:ring-4 focus:ring-brand-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-brand-600 dark:hover:bg-brand-700 focus:outline-none dark:focus:ring-brand-800 transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span x-text="showForm ? 'Cancelar Cadastro' : 'Novo Fornecedor'"></span>
        </button>
    </div>

    <!-- Alerts -->
    {% include "include/_alert.html" %}

    <!-- Form Section (Collapsible) -->
    <div x-show="showForm" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform -translate-y-4"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform -translate-y-4" class="mb-8" style="display: none;">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Novo Fornecedor</h3>
            <form action="" method="post">{% csrf_token %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    {% for field in form %}
                    {% include "include/_form_field_standard.html" with field=field %}
                    {% endfor %}
                </div>

                <!-- Contacts Formset -->
                <div class="mb-6">
                    <h4 class="text-md font-medium text-gray-900 dark:text-white mb-4">Contatos</h4>
                    {{ form_contact.management_form }}
                    <div id="inline_form">
                        <table class="w-full">
                            <tbody>
                                {% for form in form_contact %}
                                <tr class="border-b border-gray-200 dark:border-gray-700">
                                    {{ form.id }}
                                    <td class="px-2 py-2">
                                        {% include "include/_form_field_standard.html" with field=form.kind %}
                                    </td>
                                    <td class="px-2 py-2">
                                        {% include "include/_form_field_standard.html" with field=form.value %}
                                    </td>
                                    <td class="px-2 py-2">
                                        <div class="flex items-center h-full pt-7">
                                            {{ form.whatsapp }}
                                            <label
                                                class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Whatsapp?</label>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex justify-end mt-6">
                    <button type="submit"
                        class="text-white bg-brand-600 hover:bg-brand-700 focus:ring-4 focus:outline-none focus:ring-brand-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-brand-600 dark:hover:bg-brand-700 dark:focus:ring-brand-800 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                        Salvar Fornecedor
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Table Container -->
    <div
        class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Lista de Fornecedores</h3>
        </div>
        <div class="relative overflow-x-auto">
            <table class="w-full text-xs text-left text-gray-500 dark:text-gray-400">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                    <tr>
                        <th scope="col" class="px-3 py-2">Razão Social</th>
                        <th scope="col" class="px-3 py-2">Nome Fantasia</th>
                        <th scope="col" class="px-3 py-2">CNPJ</th>
                        <th scope="col" class="px-3 py-2">Contatos</th>
                        <th scope="col" class="px-3 py-2 text-right">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for supplier in suppliers %}
                    <tr
                        class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                        <th scope="row"
                            class="px-3 py-2 font-medium text-gray-900 whitespace-nowrap dark:text-white max-w-xs truncate"
                            title="{{ supplier.company }}">
                            <a href="{{ supplier.get_absolute_url }}"
                                class="hover:underline hover:text-brand-600 dark:hover:text-brand-400">
                                {{ supplier.company }}
                            </a>
                        </th>
                        <td class="px-3 py-2 max-w-xs truncate" title="{{ supplier.trade }}">{{ supplier.trade }}</td>
                        <td class="px-3 py-2 whitespace-nowrap">{{ supplier.cnpj }}</td>
                        <td class="px-3 py-2">
                            <ul class="max-w-md space-y-1 text-gray-500 list-inside dark:text-gray-400">
                                {% for sc in supplier.suppliers.all %}
                                <li class="flex items-center gap-2 text-[10px]">
                                    {% if sc.kind == 'P' %}
                                    <svg class="w-3 h-3 text-gray-500" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z">
                                        </path>
                                    </svg>
                                    {% elif sc.kind == 'E'%}
                                    <svg class="w-3 h-3 text-gray-500" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    {% endif %}
                                    {{sc.value}}
                                    {% if sc.whatsapp %}
                                    <span class="text-green-500" title="Whatsapp">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 16 16">
                                            <path
                                                d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z" />
                                        </svg>
                                    </span>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        </td>
                        <td class="px-3 py-2 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <a href="{{ supplier.get_absolute_url }}"
                                    class="text-blue-600 dark:text-blue-500 hover:underline" title="Visualizar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                                        </path>
                                    </svg>
                                </a>
                                <a href="{% url 'suppliers:fornecedor_update' supplier.slug %}"
                                    class="text-yellow-600 dark:text-yellow-500 hover:underline" title="Editar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                        </path>
                                    </svg>
                                </a>
                                <a href="{% url 'suppliers:fornecedor_delete' supplier.slug %}"
                                    class="text-red-600 dark:text-red-500 hover:underline" title="Excluir">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-3 py-8 text-center">
                            <div class="flex flex-col items-center justify-center text-gray-500 dark:text-gray-400">
                                <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                                    </path>
                                </svg>
                                <p class="text-sm">Nenhum fornecedor cadastrado.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock content %}
{% block script %}
<script src="{% static 'js/jquery.formset.js' %}"></script>
<script type="text/javascript">
    $(function () {
        $('#inline_form table tbody tr').formset({
            prefix: '{{ form_contact.prefix }}',
            addText: 'Adicionar Contato',
            deleteText: 'Remover',
            addCssClass: 'inline-flex items-center px-3 py-2 text-sm font-medium text-brand-600 bg-brand-50 rounded-lg hover:bg-brand-100 dark:text-brand-400 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors mt-2',
            deleteCssClass: 'text-red-600 hover:text-red-800 text-sm font-medium',
        });
    })
</script>
{% endblock script %}