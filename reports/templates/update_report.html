{% extends "_base.html" %}
{% load static %}
{% load ui_tags %}

{% block title %}Editar Laudo{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6">
    <div class="flex items-center gap-3 mb-2">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Editar Laudo</h1>
        <span
            class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-brand-100 text-brand-800 dark:bg-brand-900 dark:text-brand-300">
            {{ report.number_report }}
        </span>
    </div>
    <p class="text-sm text-gray-500 dark:text-gray-400">Atualize as informações do laudo técnico.</p>
</div>

<!-- Alerts (Toasts will handle this via base) -->

<form action="" method="post">{% csrf_token %}
    <div class="space-y-6">

        <!-- Main Info Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Informações Gerais</h3>

            <!-- Grid Layout Alterado para Row (3 colunas em telas médias) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <!-- Sector com Botão de Adicionar -->
                <div class="md:col-span-1">
                    <label for="{{ form.sector.id_for_label }}"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                        {{ form.sector.label }}
                    </label>
                    <div class="flex gap-2">
                        <div class="flex-1">
                            {{ form.sector }}
                        </div>
                        <button type="button" onclick="openSectorModal()"
                            class="shrink-0 inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-white bg-brand-600 rounded-lg hover:bg-brand-700 focus:ring-4 focus:outline-none focus:ring-brand-300 dark:bg-brand-600 dark:hover:bg-brand-700 dark:focus:ring-brand-800"
                            title="Adicionar Novo Setor">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                    </div>
                    {{ form.sector.errors }}
                </div>

                <!-- Employee -->
                <div>
                    <label for="{{ form.employee.id_for_label }}"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                        {{ form.employee.label}}
                    </label>
                    {{ form.employee }}
                    {{ form.employee.errors }}
                </div>

                <!-- Status -->
                <div>
                    <label for="{{ form.status.id_for_label }}"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                        {{ form.status.label}}
                    </label>
                    {{ form.status }}
                    {{ form.status.errors }}
                </div>

                <!-- Professional (Hidden) -->
                {{ form.professional }}

                <!-- Pro Accountable (Condicionalmente visível via backend) -->
                {% if not form.pro_accountable.is_hidden %}
                <div>
                    <label for="{{ form.pro_accountable.id_for_label }}"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                        {{ form.pro_accountable.label }}
                    </label>
                    {{ form.pro_accountable }}
                    {{ form.pro_accountable.errors }}
                </div>
                {% else %}
                {{ form.pro_accountable }}
                {% endif %}

                <!-- Justification (Full Width) -->
                <div class="md:col-span-3">
                    <label for="{{ form.justification.id_for_label }}"
                        class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                        {{ form.justification.label}}
                    </label>
                    {{ form.justification }}
                    {{ form.justification.errors }}
                </div>
            </div>
        </div>

        <!-- Materials Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Materiais</h3>
                <span class="text-xs text-gray-500 dark:text-gray-400">Gerencie os materiais do laudo</span>
            </div>

            <!-- Formset Container -->
            <div id="material-formset">
                {{ form_material.management_form }}
                <div class="space-y-3" id="formset-container">
                    {% for fm in form_material %}
                    <div
                        class="material-item flex flex-col sm:flex-row gap-4 items-start sm:items-end bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600">
                        <!-- Hidden Fields (ID, etc) -->
                        {% for hidden in fm.hidden_fields %}
                        {{ hidden }}
                        {% endfor %}

                        <!-- Material Select -->
                        <div class="flex-1 w-full">
                            <label
                                class="block mb-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Material</label>
                            {{ fm.material_bidding }}
                            {{ fm.material_bidding.errors }}
                        </div>

                        <!-- Quantity Input -->
                        <div class="w-full sm:w-32">
                            <label
                                class="block mb-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Qtd.</label>
                            {{ fm.quantity }}
                            {{ fm.quantity.errors }}
                        </div>

                        <!-- Delete Button (Existing Items) -->
                        <div class="self-center sm:self-end mb-1">
                            <div class="hidden">{{ fm.DELETE }}</div>
                            {% action_button url='javascript:void(0)' type='delete' extra_classes='delete-row p-2'
                            title='Remover Material' %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Add Button -->
                <button type="button" id="add-material-btn"
                    class="inline-flex items-center justify-center w-full px-4 py-2 mt-4 text-sm font-medium text-brand-600 bg-brand-50 border border-brand-200 rounded-lg hover:bg-brand-100 dark:bg-gray-700 dark:text-brand-400 dark:border-gray-600 dark:hover:bg-gray-600 transition-colors cursor-pointer dashed-border">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Adicionar Material
                </button>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-end gap-4">
            <a href="{% url 'reports:reports' %}"
                class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-4 focus:outline-none focus:ring-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:text-white dark:focus:ring-gray-700 transition-colors">
                Cancelar
            </a>
            <button type="submit"
                class="text-white bg-brand-600 hover:bg-brand-700 focus:ring-4 focus:ring-brand-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-brand-600 dark:hover:bg-brand-700 focus:outline-none dark:focus:ring-brand-800 transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Atualizar Laudo
            </button>
        </div>
    </div>
</form>

<!-- Template for New Material Item -->
<template id="material-template">
    <div
        class="material-item flex flex-col sm:flex-row gap-4 items-start sm:items-end bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border border-gray-200 dark:border-gray-600 animate-fade-in">
        <!-- Hidden Fields -->
        {% for hidden in form_material.empty_form.hidden_fields %}
        {{ hidden }}
        {% endfor %}

        <!-- Material Select -->
        <div class="flex-1 w-full">
            <label class="block mb-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Material</label>
            {{ form_material.empty_form.material_bidding }}
            {{ form_material.empty_form.material_bidding.errors }}
        </div>

        <!-- Quantity Input -->
        <div class="w-full sm:w-32">
            <label class="block mb-1 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Qtd.</label>
            {{ form_material.empty_form.quantity }}
            {{ form_material.empty_form.quantity.errors }}
        </div>

        <!-- Delete Button -->
        <div class="self-center sm:self-end mb-1">
            <div class="hidden">{{ form_material.empty_form.DELETE }}</div>
            {% action_button url='javascript:void(0)' type='delete' extra_classes='delete-row p-2' title='Remover
            Material' %}
        </div>
    </div>
</template>

<!-- Modal Adicionar Setor -->
<div id="sectorModal" tabindex="-1" aria-hidden="true"
    class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full bg-gray-900/50 backdrop-blur-sm flex items-center justify-center">
    <div class="relative w-full max-w-md max-h-full">
        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <button type="button" onclick="closeSectorModal()"
                class="absolute top-3 right-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white">
                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6" />
                </svg>
                <span class="sr-only">Fechar modal</span>
            </button>
            <div class="px-6 py-6 lg:px-8">
                <h3 class="mb-4 text-xl font-medium text-gray-900 dark:text-white">Adicionar Novo Setor</h3>
                <form class="space-y-6" id="newSectorForm">
                    <div>
                        <label for="new_sector_name"
                            class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nome do Setor</label>
                        <input type="text" name="name" id="new_sector_name"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-brand-500 focus:border-brand-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"
                            placeholder="Ex: Financeiro" required>
                    </div>
                    <button type="submit"
                        class="w-full text-white bg-brand-600 hover:bg-brand-700 focus:ring-4 focus:outline-none focus:ring-brand-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-brand-600 dark:hover:bg-brand-700 dark:focus:ring-brand-800">Salvar
                        Setor</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block script %}
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // Formset Logic
        const container = document.getElementById('formset-container');
        const addButton = document.getElementById('add-material-btn');
        const totalForms = document.getElementById('id_{{ form_material.prefix }}-TOTAL_FORMS');
        const template = document.getElementById('material-template');

        addButton.addEventListener('click', function () {
            const count = parseInt(totalForms.value);
            const newRow = template.content.cloneNode(true);

            // Update IDs and Names
            // We need to replace __prefix__ with the current count
            // Note: form_material.empty_form uses __prefix__ automatically
            newRow.querySelectorAll('[name*="__prefix__"], [id*="__prefix__"], [for*="__prefix__"]').forEach(el => {
                if (el.name) el.name = el.name.replace('__prefix__', count);
                if (el.id) el.id = el.id.replace('__prefix__', count);
                if (el.htmlFor) el.htmlFor = el.htmlFor.replace('__prefix__', count);
            });

            container.appendChild(newRow);
            totalForms.value = count + 1;
        });

        // Event delegation for delete buttons
        container.addEventListener('click', function (e) {
            const deleteBtn = e.target.closest('.delete-row');
            if (deleteBtn) {
                const row = deleteBtn.closest('.material-item');
                // Check for DELETE checkbox (Django's way of deleting existing items)
                const deleteInput = row.querySelector('input[name$="-DELETE"]');

                if (deleteInput) {
                    // If it's an existing item (has a hidden DELETE field), check it and hide the row
                    deleteInput.checked = true;
                    row.style.display = 'none';
                } else {
                    // If it's a new dynamic item (no DELETE field or just created), remove it from DOM
                    row.remove();
                    // We don't strictly need to decrement TOTAL_FORMS for Django to work, 
                    // but we could if we wanted to be precise. Django handles gaps.
                }
            }
        });
    });

    // Modal Logic
    function openSectorModal() {
        document.getElementById('sectorModal').classList.remove('hidden');
    }

    function closeSectorModal() {
        document.getElementById('sectorModal').classList.add('hidden');
    }

    // AJAX Create Sector
    document.getElementById('newSectorForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const name = document.getElementById('new_sector_name').value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('{% url "reports:create_sector_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ name: name })
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Erro: ' + data.error);
                } else {
                    // Add new option to select
                    const select = document.querySelector('select[name="sector"]');
                    const option = new Option(data.name, data.id);
                    select.add(option, undefined);
                    select.value = data.id;

                    // Close modal and clear input
                    closeSectorModal();
                    document.getElementById('new_sector_name').value = '';

                    // Show success toast
                    window.dispatchEvent(new CustomEvent('toast', {
                        detail: { message: 'Setor criado com sucesso!', type: 'success' }
                    }));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                window.dispatchEvent(new CustomEvent('toast', {
                    detail: { message: 'Erro ao criar setor', type: 'error' }
                }));
            });
    });
</script>

<style>
    .dashed-border {
        border-style: dashed;
        border-width: 2px;
    }
</style>
{% endblock script %}