{% load ui_tags %}
<div class="relative overflow-x-auto">
    <table class="w-full text-xs text-left text-gray-500 dark:text-gray-400">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
                <th scope="col" class="px-3 py-2">Nome</th>
                <th scope="col" class="px-3 py-2">Unidade</th>
                <th scope="col" class="px-3 py-2 text-right">A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for material in page_obj %}
            <tr
                class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                <th scope="row" class="px-3 py-2 font-medium text-gray-900 whitespace-nowrap dark:text-white relative">
                    <div x-data="{ 
                        showTooltip: false,
                        openUpward: false,
                        checkPosition(event) {
                            const rect = event.target.getBoundingClientRect();
                            const spaceBelow = window.innerHeight - rect.bottom;
                            const spaceAbove = rect.top;
                            this.openUpward = spaceBelow < 300 && spaceAbove > 200;
                        }
                    }" class="relative inline-block">
                        <span @mouseenter="checkPosition($event); showTooltip = true" @mouseleave="showTooltip = false"
                            class="cursor-help border-b border-dashed border-gray-400 dark:border-gray-500">
                            {{ material.name }}
                        </span>

                        <!-- Tooltip (dynamic positioning) -->
                        <div x-show="showTooltip" x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 transform scale-95"
                            x-transition:enter-end="opacity-100 transform scale-100"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100 transform scale-100"
                            x-transition:leave-end="opacity-0 transform scale-95"
                            :class="openUpward ? 'bottom-full mb-2' : 'top-full mt-2'"
                            class="absolute z-50 left-0 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 p-4"
                            style="display: none;">

                            <div class="space-y-3">
                                <!-- Header -->
                                <div class="border-b border-gray-200 dark:border-gray-700 pb-2">
                                    <h4 class="font-semibold text-sm text-gray-900 dark:text-white">
                                        üìä Informa√ß√µes de Uso
                                    </h4>
                                </div>

                                <!-- Licita√ß√µes -->
                                <div>
                                    <p class="text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                        üè∑Ô∏è Licita√ß√µes:
                                    </p>
                                    {% with bidding_info=material.get_bidding_info %}
                                    {% if bidding_info.count > 0 %}
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                                        <span class="font-semibold">{{ bidding_info.count }}</span> licita√ß√£o(√µes)
                                        ‚Ä¢ <span class="font-semibold">{{ bidding_info.total_quantity }}</span> unidades
                                    </p>
                                    <ul class="text-xs text-gray-500 dark:text-gray-400 space-y-0.5 ml-2">
                                        {% for bidding in bidding_info.biddings %}
                                        <li class="truncate">‚Ä¢ {{ bidding.name }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <p class="text-xs text-gray-500 dark:text-gray-400 italic">
                                        N√£o cadastrado em licita√ß√µes
                                    </p>
                                    {% endif %}
                                    {% endwith %}
                                </div>

                                <!-- Laudos -->
                                <div>
                                    <p class="text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">
                                        üìã Laudos:
                                    </p>
                                    {% with report_usage=material.get_report_usage %}
                                    {% if report_usage.count > 0 %}
                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                                        <span class="font-semibold">{{ report_usage.count }}</span> laudo(s)
                                        ‚Ä¢ <span class="font-semibold">{{ report_usage.total_used }}</span> unidades
                                        usadas
                                    </p>
                                    <ul class="text-xs text-gray-500 dark:text-gray-400 space-y-0.5 ml-2">
                                        {% for report_name in report_usage.recent_reports %}
                                        <li class="truncate">‚Ä¢ {{ report_name }}</li>
                                        {% endfor %}
                                        {% if report_usage.has_more %}
                                        <li class="text-gray-400 dark:text-gray-500">...</li>
                                        {% endif %}
                                    </ul>
                                    {% else %}
                                    <p class="text-xs text-gray-500 dark:text-gray-400 italic">
                                        Nenhum laudo registrado
                                    </p>
                                    {% endif %}
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                    </div>
                </th>
                <td class="px-3 py-2 text-gray-700 dark:text-gray-300">
                    {{ material.unit|default:"-" }}
                </td>
                <td class="px-3 py-2 text-right">
                    <div class="flex items-center justify-end gap-2">
                        {% url 'bidding_procurement:update_material' material.slug as update_url %}
                        {% action_button url=update_url type='edit' title='Editar' %}
                        
                        {% url 'bidding_procurement:delete_material' material.slug as delete_url %}
                        {% action_button url=delete_url type='delete' title='Excluir' %}
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td class="px-3 py-8 text-center text-gray-500 dark:text-gray-400" colspan="3">
                    <div class="flex flex-col items-center justify-center">
                        <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                            </path>
                        </svg>
                        <p class="text-sm">Nenhum material cadastrado.</p>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div class="w-full flex justify-center mt-4">
    {% include "include/_pagination.html" %}
</div>